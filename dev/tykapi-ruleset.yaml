rules:
  no-keyless-auth:
    description: APIs must not be keyless
    given: "$.use_keyless"
    severity: error
    then:
      field: use_keyless 
      function: truthy

  no-empty-target-url:
    description: APIs must have a target_url
    given: "$.proxy"
    severity: error
    then:
      field: 'target_url'
      function: 'pattern'
      functionOptions:
        match: '^(?!\s*$).+'

  require-security-config:
    description: APIs must have either JWT or mutualTLS authentication must be enabled
    severity: error
    given: "$"
    then:
      - field: enable_jwt
        function: truthy
        functionOptions:
          truthy:
            - true
        message: Either 'JWT' or 'mutualTLS' must be enabled.
      - field: auth_configs.use_mutual_tls_auth
        function: truthy
        functionOptions:
          truthy:
            - true
        message: Either 'JWT' or 'mutualTLS' must be enabled.
    # Custom rule logic to ensure that at least one of the fields is true
    custom:
      function: |
        function validate(context) {
          const enableJwt = context.targetObj.enable_jwt;
          const mutualTlsAuth = context.targetObj.auth_configs?.use_mutual_tls_auth;
          
          if (enableJwt !== true && mutualTlsAuth !== true) {
            context.report({
              message: "Either 'JWT' or 'mutualTLS' must be enabled.",
              path: context.path,
            });
          }
        }
        return {
          validate,
        }
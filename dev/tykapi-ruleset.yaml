rules:
  no-keyless-auth:
    description: APIs must not be keyless
    given: "$.use_keyless"
    severity: error
    then:
      field: use_keyless 
      function: truthy

  no-empty-target-url:
    description: APIs must have a target_url
    given: "$.proxy"
    severity: error
    then:
      field: 'target_url'
      function: 'pattern'
      functionOptions:
        match: '^(?!\s*$).+'

  security-authentication:
    description: |
      The API specification must specify either JWT authentication or mutual TLS authentication.
    message: |
      Either `.enable_jwt` must be true or `.auth_configs.use_mutual_tls_auth` must be true.
    given: $  # Root level
    then:
      field: $  # Root level
      function: anyOf
      functionOptions:
        criteria:
          - field: enable_jwt
            function: truthy
          - field: auth_configs.use_mutual_tls_auth
            function: truthy
    severity: error